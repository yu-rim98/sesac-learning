<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <title>검색</title>
  <style>
    .search-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }
    .search-item {
      position: relative;
      padding-bottom: 100%;
    }
    .search-item img,
    .search-item .no-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .search-item .no-image {
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .search-item .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .search-item:hover .overlay {
      opacity: 1;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <!-- 검색 폼 -->
  <div class="row justify-content-center mb-4">
    <div class="col-md-6">
      <div id="search-form" class="d-flex">
        <input type="text" id="search-input" class="form-control me-2"
               placeholder="검색어를 입력하세요">
        <button type="button" id="search-btn" class="btn btn-primary">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 검색 결과 -->
  <div id="search-results" style="display: none;">
    <!-- 탭 -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" href="#" data-tab="users">
          사용자 <span id="users-count" class="badge bg-secondary">0</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" data-tab="posts">게시물</a>
      </li>
    </ul>

    <!-- 사용자 검색 결과 -->
    <div id="users-tab">
      <div id="users-empty" class="text-center py-5" style="display: none;">
        <i class="bi bi-person-x fs-1 text-muted"></i>
        <p class="mt-3 text-muted">검색 결과가 없습니다.</p>
      </div>
      <div id="users-container" class="list-group"></div>
    </div>

    <!-- 게시물 검색 결과 (무한 스크롤) -->
    <div id="posts-tab" style="display: none;">
      <div id="posts-empty" class="text-center py-5" style="display: none;">
        <i class="bi bi-file-earmark-x fs-1 text-muted"></i>
        <p class="mt-3 text-muted">검색 결과가 없습니다.</p>
      </div>
      <div id="posts-container" class="search-grid"></div>
      <div id="posts-loading" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <div id="posts-no-more" class="text-center py-4 text-muted" style="display: none;">
        더 이상 게시물이 없습니다.
      </div>
      <div id="posts-scroll-trigger"></div>
    </div>
  </div>

  <!-- 검색 전 안내 -->
  <div id="search-guide" class="text-center py-5">
    <i class="bi bi-search fs-1 text-muted"></i>
    <p class="mt-3 text-muted">사용자나 게시물을 검색해보세요.</p>
  </div>

  <script>
    (function() {
      let currentQuery = '';
      let postsPage = 0;
      let isPostsLoading = false;
      let postsLastPage = false;
      let postsObserver = null;

      const searchForm = document.getElementById('search-form');
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');
      const searchGuide = document.getElementById('search-guide');

      const usersTab = document.getElementById('users-tab');
      const postsTab = document.getElementById('posts-tab');
      const usersContainer = document.getElementById('users-container');
      const postsContainer = document.getElementById('posts-container');
      const usersEmpty = document.getElementById('users-empty');
      const postsEmpty = document.getElementById('posts-empty');
      const postsLoading = document.getElementById('posts-loading');
      const postsNoMore = document.getElementById('posts-no-more');
      const postsScrollTrigger = document.getElementById('posts-scroll-trigger');
      const usersCount = document.getElementById('users-count');

      // 탭 클릭 처리
      document.querySelectorAll('[data-tab]').forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          const tabName = e.target.closest('[data-tab]').dataset.tab;
          switchTab(tabName);
        });
      });

      function switchTab(tabName) {
        document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        usersTab.style.display = tabName === 'users' ? 'block' : 'none';
        postsTab.style.display = tabName === 'posts' ? 'block' : 'none';
      }

      // 검색 버튼 클릭
      document.getElementById('search-btn').addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) {
          performSearch(query);
        }
      });

      // Enter 키 검색
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = searchInput.value.trim();
          if (query) {
            performSearch(query);
          }
        }
      });

      async function performSearch(query) {
        currentQuery = query;
        searchGuide.style.display = 'none';
        searchResults.style.display = 'block';

        // 사용자 검색
        await searchUsers(query);

        // 게시물 검색 초기화
        resetPostsSearch();
        await loadPosts();
      }

      async function searchUsers(query) {
        try {
          const response = await fetch(`/api/search/users?q=${encodeURIComponent(query)}`);
          const users = await response.json();

          usersContainer.innerHTML = '';
          usersCount.textContent = users.length;

          if (users.length === 0) {
            usersEmpty.style.display = 'block';
          } else {
            usersEmpty.style.display = 'none';
            users.forEach(user => {
              usersContainer.insertAdjacentHTML('beforeend', createUserHTML(user));
            });
          }
        } catch (error) {
          console.error('Failed to search users:', error);
        }
      }

      function createUserHTML(user) {
        return `
                <a href="/users/${user.username}" class="list-group-item list-group-item-action d-flex align-items-center">
                    <img src="${user.profileImageUrl || '/images/default-profile.png'}"
                         class="rounded-circle me-3" width="50" height="50"
                         style="object-fit: cover;" alt="프로필">
                    <div>
                        <h6 class="mb-0">${user.username}</h6>
                        <small class="text-muted">${user.name || ''}</small>
                    </div>
                </a>
            `;
      }

      function resetPostsSearch() {
        postsPage = 0;
        postsLastPage = false;
        postsContainer.innerHTML = '';
        postsEmpty.style.display = 'none';
        postsNoMore.style.display = 'none';
      }

      async function loadPosts() {
        if (isPostsLoading || postsLastPage || !currentQuery) return;

        isPostsLoading = true;
        document.getElementById('posts-loading').style.display = 'block';

        try {
          const response = await fetch(`/api/search/posts?q=${encodeURIComponent(currentQuery)}&page=${postsPage}&size=12`);
          const data = await response.json();

          if (data.content.length === 0 && postsPage === 0) {
            postsEmpty.style.display = 'block';
          } else {
            data.content.forEach(post => {
              postsContainer.insertAdjacentHTML('beforeend', createPostHTML(post));
            });
          }

          // Slice: last 또는 hasNext로 다음 페이지 확인
          postsLastPage = data.last;
          if (postsLastPage && data.content.length > 0) {
            postsNoMore.style.display = 'block';
          }

          postsPage++;
        } catch (error) {
          console.error('Failed to load posts:', error);
        } finally {
          isPostsLoading = false;
          document.getElementById('posts-loading').style.display = 'none';
        }
      }

      function createPostHTML(post) {
        return `
                <a href="/posts/${post.id}" class="search-item">
                    ${post.imageUrl
            ? `<img src="${post.imageUrl}" alt="게시물">`
            : `<div class="no-image"><p class="text-muted small text-center p-2 m-0">${(post.content || '').substring(0, 50)}</p></div>`
        }
                    <div class="overlay text-white">
                        <span class="me-3"><i class="bi bi-heart-fill"></i> ${post.likeCount}</span>
                        <span><i class="bi bi-chat-fill"></i> ${post.commentCount}</span>
                    </div>
                </a>
            `;
      }

      // Intersection Observer
      postsObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && postsTab.style.display !== 'none') {
            loadPosts();
          }
        });
      }, { rootMargin: '100px' });

      postsObserver.observe(postsScrollTrigger);

      // URL에서 검색어가 있으면 자동 검색
      const urlParams = new URLSearchParams(window.location.search);
      const initialQuery = urlParams.get('q');
      if (initialQuery) {
        searchInput.value = initialQuery;
        performSearch(initialQuery);
      }
    })();
  </script>
</div>
</body>
</html>